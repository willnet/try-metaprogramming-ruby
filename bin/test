#!/usr/bin/env bash

# Ruby-first ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Ruby ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ JavaScript ã«åŒæœŸã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•
cd "$PROJECT_ROOT"

echo "ğŸ”„ Syncing Ruby files to JavaScript..."
node scripts/sync-ruby-to-js.js

echo ""
echo "ğŸ“Š Generating test problems JSON..."
node scripts/generate-test-json.js

echo ""
echo "ğŸ§ª Running comprehensive answer tests..."
ruby test/test_answers_comprehensive.rb

# å¼•æ•°ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã€ç‰¹å®šã®å•é¡Œã‚’ãƒ†ã‚¹ãƒˆ
if [ $# -eq 2 ]; then
    echo ""
    echo "ğŸ¯ Testing specific problem: $1/$2"
    ruby test/test_answers_comprehensive.rb "$1" "$2"
fi

echo ""
echo "ğŸŒ Running E2E browser tests..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
echo "ğŸ“¦ Building project..."
node esbuild.config.js

# ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’é–‹å§‹ï¼ˆãƒãƒ¼ãƒˆ8001ï¼‰
echo "ğŸš€ Starting test server on port 8001..."
cd dist
ruby -run -e httpd . -p 8001 &
SERVER_PID=$!
cd ..

# ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã¤
echo "â³ Waiting for server to start..."
for i in {1..30}; do
    if curl -s http://localhost:8001 > /dev/null 2>&1; then
        echo "âœ… Server is ready!"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "âŒ Server failed to start within 30 seconds"
        kill $SERVER_PID 2>/dev/null
        exit 1
    fi
    sleep 1
done

# ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p test/screenshots

# Playwrightã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›ã®ã¿ï¼‰
if [ ! -d "node_modules/@playwright" ]; then
    echo "ğŸ“¦ Installing Playwright browsers..."
    npx playwright install chromium
fi

# E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆå…¨å•é¡Œï¼‰
echo "ğŸ­ Running E2E tests..."
npx playwright test test/test_e2e.js --reporter=line

E2E_EXIT_CODE=$?

# ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
echo "ğŸ›‘ Stopping test server..."
kill $SERVER_PID 2>/dev/null
wait $SERVER_PID 2>/dev/null

if [ $E2E_EXIT_CODE -eq 0 ]; then
    echo "âœ… E2E tests passed!"
else
    echo "âŒ E2E tests failed!"
    exit $E2E_EXIT_CODE
fi

echo ""
echo "âœ… All tests completed!"